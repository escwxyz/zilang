---
import InquiryForm from "@/components/InquiryForm.astro";
import type { CarouselImage } from "@/components/image-carousel/types";
import Link from "@/components/Link.astro";
import RichText from "@/components/RichText.astro";
import { ImageCarousel } from "@/components/image-carousel";
import Layout from "@/layouts/Layout.astro";
import { getCollectionBySlug } from "@/lib/data";
import { getUrl } from "@/lib/utils";

const { slug } = Astro.params;

if (typeof slug !== "string") {
  Astro.redirect("/products/pump-controllers");
}

const productData = await getCollectionBySlug(
  "pump-controllers",
  slug as string,
);

if (!productData || productData.docs.length === 0) {
  Astro.redirect("/products/pump-controllers");
}

const product = productData.docs[0];

const { gallery } = product;

const hasGallery =
  gallery.length > 0 && gallery.every((item) => typeof item === "object");

const images: CarouselImage[] = hasGallery
  ? gallery
      .map((item) => {
        if (item.url) {
          return {
            url: getUrl(item.url),
            title: item.alt,
          };
        }
        return null;
      })
      .filter((item): item is CarouselImage => item !== null)
  : [];
---

<Layout>
  <div class="container mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <ImageCarousel images={images} showCarouselControls={false} />
      <div class="mt-4 space-y-4">
        <h1 class="text-2xl font-bold">{product.title}</h1>
        <div class="mt-2">
          <RichText data={product.description} />
        </div>
        <Link type="internal" url="#contact-form" className="text-blue-500">
          Contact Us
        </Link>
      </div>
    </div>
    <div id="contact-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h2 class="text-lg font-bold">Contact Us</h2>
        <p class="text-gray-600">
          Please fill out the form below to contact us.
          <br />
          We will get back to you as soon as possible.
          <br />
          <br />
          <strong>
            Please note that we are not able to provide technical support for
            this product.
          </strong>
        </p>
      </div>
      <div class="grid place-items-center">
        <InquiryForm productId={product.id} />
      </div>
    </div>
  </div>
</Layout>
