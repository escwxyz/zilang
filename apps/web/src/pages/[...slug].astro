---
import Layout from "@/layouts/Layout.astro";
import BlocksRenderer from "@/components/BlocksRenderer.astro";
import { getCachedCollectionBySlug } from "@/lib/data";
import { getDrizzleDB } from "@/db/client";
import { D1Cache } from "@/lib/cache";

const { env } = Astro.locals.runtime;

const db = getDrizzleDB(env);

const cache = new D1Cache(db.$client);

const { slug } = Astro.params;

const pageSlug = slug ?? "home";

const pageData = await getCachedCollectionBySlug(
  cache,
  "pages",
  pageSlug,
  {
    where: {
      _status: {
        equals: "published",
      },
    },
  },
  {
    skipCache: true,
  },
);

if (pageData.docs.length === 0) {
  return Astro.redirect("/404");
}

const page = pageData.docs[0];
---

<Layout>
  <BlocksRenderer blocks={page.content} />
</Layout>
